# Документация системы управления игрой

## Как настроить игру в Unity

### 1. Начальная настройка сцены

#### Создание основной сетки:
1. Создайте пустой GameObject и назовите его "Grid"
2. Добавьте компонент Grid (Component → Layout → Grid)
3. Настройте размер ячеек (Cell Size: 1x1x1)
4. Создайте дочерний объект "GridSurface" с компонентом Sprite Renderer для визуализации поверхности

#### Настройка камеры:
1. Выберите Main Camera
2. Установите Orthographic проекцию
3. Позиция камеры: X=0, Y=10, Z=0
4. Поворот камеры: X=90, Y=0, Z=0
5. Размер камеры: настройте в зависимости от размера сетки

### 2. Настройка робота

#### Создание префаба робота:
1. Создайте 3D объект (например, куб) и назовите его "Robot"
2. Добавьте компонент RobotController.cs
3. Настройте визуальное представление (спрайт или 3D модель)
4. Добавьте компонент Collider для обнаружения столкновений
5. Преобразуйте в префаб и поместите в папку Prefabs

#### Параметры RobotController:
- Speed: 2.0 (скорость движения)
- RotationSpeed: 5.0 (скорость поворота)
- JumpForce: 8.0 (сила прыжка)

### 3. Настройка системы управления уровнями

#### Создание LevelManager:
1. Создайте пустой GameObject и назовите его "LevelManager"
2. Добавьте компонент LevelManager.cs
3. В инспекторе создайте массив уровней
4. Настройте ссылки на UI элементы (LevelCompletePanel, etc.)

#### Создание LevelData ScriptableObjects:
1. Щелкните правой кнопкой мыши в папке Resources/Levels
2. Выберите Create → Robot Coder → Level Data
3. Настройте параметры уровня:
   - Level Index: порядковый номер уровня
   - Level Name: название уровня
   - Description: описание уровня
   - Difficulty: сложность уровня (1-5)
   - Max Commands: максимальное количество команд
   - Optimal Commands: оптимальное количество команд
   - Start Position: начальная позиция робота (x,y)
   - Start Direction: начальное направление робота (0=Север, 1=Восток, 2=Юг, 3=Запад)
   - Goal Positions: массив позиций целей (x,y)
   - Grid Width: ширина сетки
   - Grid Height: высота сетки
   - Grid Layout: редактор сетки для размещения стен, ям, кнопок и других элементов
   - Available Commands: доступные команды для уровня

### 4. Настройка системы программирования

#### Создание палитры команд:
1. Создайте UI Canvas
2. Добавьте панель и назовите её "BlockPalette"
3. Добавьте компонент BlockPalette.cs
4. Создайте кнопки для каждой команды:
   - MoveForwardButton
   - TurnLeftButton
   - TurnRightButton
   - JumpButton
   - InteractButton
   - RepeatButton
   - IfButton
5. Для каждой кнопки добавьте компонент CommandBlock.cs с соответствующим типом

#### Создание рабочей области:
1. В Canvas создайте панель "WorkspacePanel"
2. Добавьте компонент WorkspacePanel.cs
3. Создайте дочерние объекты DropZone для каждой позиции команды
4. Добавьте компонент DropZone.cs к каждой зоне

#### Настройка интерпретатора:
1. Создайте пустой GameObject "ProgramInterpreter"
2. Добавьте компонент ProgramInterpreter.cs
3. Настройте ссылки на RobotController и WorkspacePanel

### 5. Настройка пользовательского интерфейса

#### Создание главного меню:
1. Создайте Canvas с MainMenuManager.cs
2. Добавьте кнопки:
   - StartButton: запуск игры
   - LevelSelectButton: выбор уровня
   - SettingsButton: настройки
   - QuitButton: выход

#### Создание игрового интерфейса:
1. Создайте Canvas с GameplayUIManager.cs
2. Добавьте элементы:
   - LevelTitleText: отображение текущего уровня
   - CommandCounterText: счетчик команд
   - MaxCommandsText: максимальное количество команд
   - StartButton: запуск программы
   - ResetButton: сброс программы
   - PauseButton: пауза
   - WinPanel: панель победы
   - LosePanel: панель поражения
   - PausePanel: панель паузы

#### Создание экрана завершения уровня:
1. Создайте панель WinPanel
2. Добавьте элементы:
   - WinTitleText: сообщение о победе
   - StarsDisplay: отображение звезд
   - ScoreText: количество очков
   - TimeText: время прохождения
   - NextLevelButton: следующий уровень
   - RetryButton: повторить уровень
   - MenuButton: возврат в меню

### 6. Настройка GameManager

#### Создание основного менеджера:
1. Создайте пустой GameObject "GameManager"
2. Добавьте компонент GameManager.cs
3. Настройте ссылки в инспекторе:
   - LevelManager
   - ProgramInterpreter
   - RobotController
   - WorkspacePanel

#### Основные параметры:
- CurrentLevel: текущий уровень
- EnableDebug: включение отладки

### 7. Настройка системы сохранений

#### Создание SaveManager:
1. Создайте пустой GameObject "SaveManager"
2. Добавьте компонент SaveManager.cs
3. Настройте параметры:
   - SaveFileName: имя файла сохранения
   - AutoSave: автоматическое сохранение

## Пошаговая настройка уровней

### Создание уровней через редактор Unity:

1. В папке Resources/Levels щелкните правой кнопкой мыши
2. Выберите Create → Robot Coder → Level Data
3. В инспекторе настройте параметры уровня:
   - Level Index: уникальный номер уровня
   - Level Name: название уровня
   - Description: описание уровня
   - Difficulty: сложность (1-5)
   - Max Commands: максимальное количество команд
   - Optimal Commands: оптимальное количество команд
   - Start Position: начальная позиция робота
   - Start Direction: начальное направление
   - Goal Positions: массив позиций целей
   - Grid Width/Height: размеры сетки
   - Используйте Grid Editor для размещения элементов на сетке

4. После настройки нажмите кнопку "Serialize Grid" в инспекторе
5. Сохраните LevelData как ассет

### Уровень 1 (Обучение):
1. Создайте LevelData объект
2. Установите Level Index = 1
3. Level Name = "Обучение"
4. Grid Width = 5, Grid Height = 5
5. Robot Start Position = (0,0)
6. Robot Start Rotation = 1 (восток)
7. Goal Position = (4,0)
8. Доступные команды: только MoveForward
9. Добавьте стены по краям сетки через Grid Editor
10. Нажмите "Serialize Grid" и сохраните

### Уровень 2 (Повороты):
1. Создайте LevelData объект
2. Установите Level Index = 2
3. Level Name = "Повороты"
4. Grid Width = 7, Grid Height = 7
5. Robot Start Position = (0,0)
6. Robot Start Rotation = 1 (восток)
7. Goal Position = (0,3)
8. Доступные команды: MoveForward, TurnLeft, TurnRight
9. Добавьте стены по краям сетки через Grid Editor
10. Нажмите "Serialize Grid" и сохраните

### Уровень 3 (Прыжки):
1. Создайте LevelData объект
2. Установите Level Index = 3
3. Level Name = "Прыжки"
4. Grid Width = 8, Grid Height = 8
5. Robot Start Position = (0,0)
6. Robot Start Rotation = 1 (восток)
7. Goal Position = (7,0)
8. Доступные команды: MoveForward, TurnLeft, TurnRight, Jump
9. Добавьте стену на (3,0) через Grid Editor
10. Нажмите "Serialize Grid" и сохраните

## Настройка бесконечных блоков в палитре

### Принцип работы:
- Блоки в палитре создаются как шаблоны и остаются там при перетаскивании
- При перетаскивании создается копия блока, а оригинальный остается в палитре
- Это позволяет использовать каждый тип команды неограниченное количество раз

### Настройка BlockPalette:
1. Убедитесь, что BlockPalette.cs имеет правильную реализацию
2. Проверьте, что DragDropHandler.cs правильно создает копии блоков
3. Убедитесь, что в палитре есть все необходимые типы команд
4. Настройте доступные команды через LevelData для каждого уровня

## Механика победы и поражения

### Победа:
- Игрок должен довести робота до цели за один запуск программы
- Если робот достигает цели, показывается панель победы
- Начисляются звезды в зависимости от эффективности использования команд

### Поражение:
- Если программа завершается, но робот не достиг цели, показывается панель поражения
- Робот автоматически возвращается в начальную позицию
- Игрок может повторить попытку

## Настройка системы перетаскивания

### Настройка DragDropHandler:
1. Добавьте компонент DragDropHandler.cs к каждому CommandBlock
2. Настройте параметры:
   - DragThreshold: 10 (минимальное расстояние для начала перетаскивания)
   - DragSpeed: 5.0 (скорость следования за курсором)

### Настройка DropZone:
1. Добавьте компонент DropZone.cs к каждой зоне в WorkspacePanel
2. Настройте параметры:
   - AcceptMultiple: false (принимать только один блок)
   - HighlightColor: цвет подсветки при наведении

## Настройка анимаций

### Анимация робота:
1. Создайте Animator Controller для робота
2. Добавьте параметры:
   - Speed (float)
   - IsMoving (bool)
   - IsJumping (bool)
   - IsTurning (bool)
3. Создайте переходы между анимациями
4. Настройте Blend Trees для плавных переходов

### Анимация UI:
1. Используйте Animation компонент для UI элементов
2. Создайте анимации для:
   - Появления/исчезновения панелей
   - Подсветки кнопок
   - Анимации звезд при завершении уровня

## Отладка и тестирование

### Горячие клавиши для тестирования:
- **F1** - Показать состояние всех систем
- **Пробел** - Старт/Стоп программы
- **R** - Сброс программы
- **Esc** - Пауза
- **F5** - Сохранить прогресс
- **F9** - Загрузить прогресс

### Рекомендации по тестированию:
1. Проверьте все уровни на проходимость
2. Убедитесь, что все команды работают корректно
3. Проверьте граничные условия (выход за пределы сетки)
4. Протестируйте систему сохранений
5. Проверьте корректность отображения UI на разных разрешениях

## Расширение функциональности

### Добавление новых команд:
1. Создайте новый класс, наследующий CommandBlock
2. Реализуйте метод Execute с логикой команды
3. Добавьте команду в палитру блоков
4. Настройте локализацию названия команды

### Создание новых типов уровней:
1. Создайте новый класс, наследующий LevelData
2. Переопределите методы для специфической логики уровня
3. Добавьте новые параметры в инспектор
4. Создайте соответствующие префабы

### Расширение UI:
1. Создайте новые компоненты в папке UI
2. Используйте существующие менеджеры как пример
3. Подключите к соответствующим игровым системам
4. Протестируйте на разных размерах экрана

## Решение проблем

### Проблема: Игра остается на паузе при выходе в меню
**Решение:** Добавлен метод ResumeGame() который сбрасывает Time.timeScale = 1f

### Проблема: Утечка памяти при переходах
**Решение:** 
- Добавлены методы очистки слушателей событий (ClearEventListeners)
- Все события отписываются в OnDestroy и OnDisable
- Корутины останавливаются при уничтожении объектов

### Проблема: Блоки не перетаскиваются
**Решение:**
- Проверьте наличие компонента DragDropHandler
- Убедитесь, что Canvas использует правильный Render Mode
- Проверьте EventSystem в сцене

### Проблема: Робот не двигается
**Решение:**
- Проверьте компонент RobotController
- Убедитесь, что ProgramInterpreter получает команды
- Проверьте настройки физики (если используется)

### Проблема: Блоки исчезают из палитры
**Решение:**
- Убедитесь, что DragDropHandler создает копии блоков
- Проверьте, что BlockPalette правильно восстанавливает шаблоны
- Убедитесь, что в палитре есть все необходимые типы команд

### Проблема: Панель поражения показывается нестабильно
**Решение:**
- Убедитесь, что GameManager проверяет завершение уровня после выполнения программы
- Проверьте, что LevelManager правильно определяет достижение цели
- Убедитесь, что RobotController корректно возвращает позицию

## Рекомендации по использованию

1. **При разработке новых компонентов:**
   - Всегда отписывайтесь от событий в OnDestroy и OnDisable
   - Останавливайте корутины при уничтожении объектов
   - Используйте null-проверки для всех ссылок

2. **При добавлении новых команд:**
   - Создавайте наследников от CommandBlock
   - Реализуйте метод Execute с логикой команды
   - Добавьте локализацию названия команды

3. **При работе с UI:**
   - Используйте ClearEventListeners перед добавлением новых слушателей
   - Проверяйте существование компонентов перед использованием
   - Обновляйте визуальные элементы при изменении состояния

4. **При настройке уровней:**
   - Тестируйте каждый уровень отдельно
   - Убедитесь в корректности координат
   - Проверяйте достижимость всех целей
   - Не забывайте сериализовать сетку после изменений